<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
<title>Equation Lab — QDS (Live)</title>
<style>
  :root{
    /* ---- UI scaling (enbiggen) ---- */
    --ui: 1;                 /* 0.92 → 1.28 recommended */
    --fs: calc(14px * var(--ui));
    --fs2: calc(12px * var(--ui));
    --fs3: calc(11px * var(--ui));

    /* ---- Theme (NASA-ish neon) ---- */
    --bg:#070A12;
    --panel:rgba(14,20,38,.72);
    --panel2:rgba(11,16,32,.62);
    --stroke:rgba(255,255,255,.10);

    --text:rgba(255,255,255,.90);
    --muted:rgba(255,255,255,.64);

    --c1:#7CF7FF;  /* cyan */
    --c2:#A7FF83;  /* neon green */
    --c3:#FF6BD6;  /* magenta */
    --c4:#FFC857;  /* amber */

    --radius:18px;
    --shadow:0 14px 40px rgba(0,0,0,.45);
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--sans);
    font-size:var(--fs);
    color:var(--text);
    background:
      radial-gradient(1100px 700px at 12% -10%, rgba(124,247,255,.18), transparent 58%),
      radial-gradient(900px 600px at 110% 10%, rgba(167,255,131,.14), transparent 56%),
      radial-gradient(1000px 700px at 60% 120%, rgba(255,107,214,.10), transparent 58%),
      radial-gradient(700px 500px at 85% 85%, rgba(255,200,87,.08), transparent 55%),
      var(--bg);
  }

  .wrap{max-width:1180px; margin:0 auto; padding:16px 14px 22px;}

  /* Header banner (more “dash”) */
  .hero{
    display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap;
    padding:14px 14px 12px;
    border:1px solid var(--stroke);
    border-radius:calc(var(--radius) + 4px);
    background:linear-gradient(180deg, rgba(14,20,38,.80), rgba(11,16,32,.55));
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
    position:relative;
    overflow:hidden;
  }
  .hero::before{
    content:"";
    position:absolute; inset:-2px;
    background:
      linear-gradient(90deg, rgba(124,247,255,.22), transparent 32%, rgba(167,255,131,.18), transparent 62%, rgba(255,107,214,.16));
    opacity:.55;
    filter: blur(18px);
    pointer-events:none;
  }
  .hero > *{position:relative}
  .hero .kicker{
    font-size:var(--fs2);
    letter-spacing:.28em;
    color:rgba(124,247,255,.78);
    text-transform:uppercase;
  }
  .hero .title{
    margin-top:6px;
    font-weight:800;
    letter-spacing:.2px;
    font-size:calc(20px * var(--ui));
    line-height:1.1;
  }
  .hero .subtitle{
    margin-top:6px;
    color:var(--muted);
    font-size:var(--fs2);
    max-width:64ch;
  }
  .hero .tag{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(7,10,18,.35);
    color:rgba(255,255,255,.70);
    font-size:var(--fs2);
    display:flex; flex-direction:column; gap:2px;
    min-width:160px;
  }

  .topbar{
    margin-top:12px;
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    padding:12px 12px;
    border:1px solid var(--stroke);
    background:var(--panel);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
  }

  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
    border:1px solid var(--stroke);
    border-radius:999px;
    background:rgba(7,10,18,.35);
    color:var(--muted);
    font-size:var(--fs2);
    white-space:nowrap;
  }
  .dot{
    width:8px; height:8px; border-radius:50%;
    background:var(--c2);
    box-shadow:0 0 0 4px rgba(167,255,131,.12);
  }

  .btn{
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--stroke);
    background:rgba(7,10,18,.35);
    color:var(--text);
    font-weight:700;
    font-size:var(--fs2);
    cursor:pointer;
    user-select:none;
  }
  .btn.secondary{color:var(--muted)}
  .btn:active{transform:translateY(1px)}
  .spacer{flex:1}

  /* Cards */
  .grid{
    display:grid; gap:12px; margin-top:12px;
    grid-template-columns: 1.05fr .95fr 1.2fr;
  }
  @media (max-width: 980px){ .grid{grid-template-columns: 1fr; } }

  .card{
    border:1px solid var(--stroke);
    background:var(--panel2);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:12px;
    position:relative;
    overflow:hidden;
  }
  /* subtle neon edge */
  .card::before{
    content:"";
    position:absolute; inset:-1px;
    background:linear-gradient(90deg, rgba(124,247,255,.20), rgba(167,255,131,.14), rgba(255,107,214,.14));
    opacity:.22;
    filter: blur(22px);
    pointer-events:none;
  }
  .card > *{position:relative}

  .card h3{
    margin:0 0 8px 0;
    font-size:calc(13px * var(--ui));
    letter-spacing:.18px;
    color:rgba(255,255,255,.86);
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .sub{color:var(--muted); font-size:var(--fs2); line-height:1.35}

  .eq{
    margin-top:10px;
    padding:14px;
    border-radius:16px;
    background:linear-gradient(180deg, rgba(7,10,18,.50), rgba(7,10,18,.30));
    border:1px solid rgba(255,255,255,.10);
    font-family:var(--mono);
    font-size:calc(14px * var(--ui));
    line-height:1.6;
    overflow:auto;
  }

  .sym{
    display:inline-block;
    padding:2px 7px;
    border-radius:12px;
    border:1px solid transparent;
    cursor:pointer;
    transition: transform .06s ease, background .12s ease, border-color .12s ease;
  }
  .sym:hover{border-color:rgba(124,247,255,.35); background:rgba(124,247,255,.10)}
  .sym:active{transform:scale(.99)}
  .sym.active{
    border-color:rgba(167,255,131,.70);
    background:rgba(167,255,131,.12);
    box-shadow:0 0 0 6px rgba(167,255,131,.08);
    color:rgba(255,255,255,.96)
  }

  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .kpi{
    display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;
  }
  .kpi .box{
    border:1px solid rgba(255,255,255,.10);
    background:rgba(7,10,18,.30);
    border-radius:16px; padding:11px;
  }
  .kpi .lab{color:var(--muted); font-size:var(--fs3)}
  .kpi .val{font-family:var(--mono); font-size:calc(16px * var(--ui)); margin-top:6px}

  .ctrl{
    margin-top:10px;
    padding:11px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(7,10,18,.30);
  }
  .ctrl label{
    display:flex; justify-content:space-between; gap:10px;
    color:var(--muted);
    font-size:var(--fs2)
  }
  .ctrl .v{font-family:var(--mono); color:var(--text)}
  input[type="range"]{width:100%; margin-top:6px}
  input[type="number"]{
    width:132px;
    border-radius:12px;
    border:1px solid rgba(255,255,255,.12);
    background:rgba(7,10,18,.40);
    color:var(--text);
    padding:9px 10px;
    font-family:var(--mono);
    font-size:var(--fs2);
  }
  .tiny{font-size:var(--fs3); color:rgba(255,255,255,.50)}

  .plot{display:grid; gap:10px; margin-top:10px}
  canvas{
    width:100%;
    height:270px; /* bigger by default */
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:linear-gradient(180deg, rgba(7,10,18,.55), rgba(7,10,18,.30));
  }
  @media (max-width: 980px){
    canvas{height:300px}
  }

  .table{
    margin-top:10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    overflow:hidden;
    background:rgba(7,10,18,.30);
  }
  .table table{width:100%; border-collapse:collapse; font-family:var(--mono); font-size:var(--fs2)}
  .table th,.table td{padding:9px 10px; border-bottom:1px solid rgba(255,255,255,.06)}
  .table th{color:var(--muted); font-weight:800; text-align:left; background:rgba(14,20,38,.35)}
  .table tr:last-child td{border-bottom:none}

  footer{
    margin-top:14px;
    padding:11px 12px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.10);
    background:rgba(14,20,38,.35);
    color:var(--muted);
    font-size:var(--fs2);
    display:flex; flex-wrap:wrap; gap:8px;
    align-items:center; justify-content:space-between;
  }
  .credit b{color:rgba(255,255,255,.88)}
  .link{color:rgba(124,247,255,.90); text-decoration:none}
</style>
</head>

<body>
  <div class="wrap">

    <section class="hero">
      <div>
        <div class="kicker">concept • live equation dashboard</div>
        <div class="title">QDS Kernel — Interactive Equation Lab</div>
        <div class="subtitle">
          Tap symbols, drag sliders, and watch the maths update in real time. Offline-first, single-file, phone-safe.
        </div>
      </div>
      <div class="tag">
        <div class="tiny">Mode</div>
        <div><b>Offline</b> • Live charts</div>
      </div>
    </section>

    <div class="topbar">
      <span class="pill" id="offlinePill"><span class="dot" id="offlineDot"></span><span id="offlineTxt">Offline OK</span></span>

      <button class="btn secondary" id="btnSmall">A−</button>
      <button class="btn secondary" id="btnBig">A+</button>

      <button class="btn secondary" id="btnReset">Reset</button>
      <button class="btn secondary" id="btnSave">Save preset</button>
      <button class="btn secondary" id="btnLoad">Load preset</button>
      <button class="btn" id="btnExport">Export JSON</button>

      <div class="spacer"></div>

      <span class="pill">Active symbol: <b id="activeSym" style="color:var(--text); font-family:var(--mono)">—</b></span>
      <span class="pill" id="perfPill">Update: <b id="perfTxt" style="color:var(--text); font-family:var(--mono)">—</b></span>
    </div>

    <div class="grid">
      <!-- LEFT: equation -->
      <section class="card">
        <h3>
          <span>Kernel equation (tap symbols)</span>
          <span class="pill">K(t,r)</span>
        </h3>
        <div class="sub">
          Double-tap the equation block to clear highlights. This is already “live”; next upgrade is multi-equation chaining.
        </div>

        <div class="eq" id="eqBox" aria-label="Equation">
          K(t,r) = <span class="sym" data-var="sigma2">σ²</span>
          · exp( - |t| / <span class="sym" data-var="tau">τ<sub>c</sub></span> )
          · exp( - r² / ( 2 · <span class="sym" data-var="lambda">λ<sub>c</sub>²</span> ) )
        </div>

        <div class="kpi">
          <div class="box">
            <div class="lab">K(t,r) @ current sliders</div>
            <div class="val" id="kNow">—</div>
          </div>
          <div class="box">
            <div class="lab">Dominant sensitivity (rough)</div>
            <div class="val" id="sensNow">—</div>
          </div>
        </div>

        <div class="table">
          <table>
            <thead><tr><th>Item</th><th>Value</th></tr></thead>
            <tbody>
              <tr><td>σ²</td><td id="tSigma">—</td></tr>
              <tr><td>τ<sub>c</sub></td><td id="tTau">—</td></tr>
              <tr><td>λ<sub>c</sub></td><td id="tLambda">—</td></tr>
              <tr><td>t</td><td id="tT">—</td></tr>
              <tr><td>r</td><td id="tR">—</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- MIDDLE: controls -->
      <section class="card">
        <h3><span>Controls</span><span class="pill">Live update</span></h3>
        <div class="sub">Sliders for speed. Number boxes for precision. All updates are throttled for phone sanity.</div>

        <div class="ctrl" id="ctrl_sigma2">
          <label><span>σ² (variance)</span><span class="v"><span id="v_sigma2"></span></span></label>
          <input type="range" id="s_sigma2" min="0.01" max="5" step="0.01" value="1">
          <div class="row">
            <span class="tiny">0.01 → 5.00</span>
            <div class="spacer"></div>
            <input type="number" id="n_sigma2" min="0.01" max="5" step="0.01" value="1">
          </div>
        </div>

        <div class="ctrl" id="ctrl_tau">
          <label><span>τ<sub>c</sub> (time corr)</span><span class="v"><span id="v_tau"></span></span></label>
          <input type="range" id="s_tau" min="0.05" max="10" step="0.01" value="1">
          <div class="row">
            <span class="tiny">Units: set your scale</span>
            <div class="spacer"></div>
            <input type="number" id="n_tau" min="0.05" max="10" step="0.01" value="1">
          </div>
        </div>

        <div class="ctrl" id="ctrl_lambda">
          <label><span>λ<sub>c</sub> (space corr)</span><span class="v"><span id="v_lambda"></span></span></label>
          <input type="range" id="s_lambda" min="0.05" max="10" step="0.01" value="1">
          <div class="row">
            <span class="tiny">Sweep λ<sub>c</sub> to watch width</span>
            <div class="spacer"></div>
            <input type="number" id="n_lambda" min="0.05" max="10" step="0.01" value="1">
          </div>
        </div>

        <div class="ctrl" id="ctrl_t">
          <label><span>t (time)</span><span class="v"><span id="v_t"></span></span></label>
          <input type="range" id="s_t" min="-10" max="10" step="0.01" value="1.2">
          <div class="row">
            <span class="tiny">|t| is used</span>
            <div class="spacer"></div>
            <input type="number" id="n_t" min="-10" max="10" step="0.01" value="1.2">
          </div>
        </div>

        <div class="ctrl" id="ctrl_r">
          <label><span>r (distance)</span><span class="v"><span id="v_r"></span></span></label>
          <input type="range" id="s_r" min="0" max="10" step="0.01" value="2.0">
          <div class="row">
            <span class="tiny">r ≥ 0</span>
            <div class="spacer"></div>
            <input type="number" id="n_r" min="0" max="10" step="0.01" value="2.0">
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn" id="btnCopy">Copy results</button>
          <span class="tiny" id="copyMsg"></span>
        </div>
      </section>

      <!-- RIGHT: plots -->
      <section class="card">
        <h3><span>Charts</span><span class="pill">Bigger + brighter</span></h3>
        <div class="sub">Plot A: K vs t (holding r). Plot B: K vs r (holding t). High contrast for OLED.</div>

        <div class="plot">
          <div>
            <div class="row">
              <span class="pill">Plot A</span><span class="tiny">K(t,r₀), r₀ = current r</span>
            </div>
            <canvas id="cA" width="980" height="340"></canvas>
          </div>
          <div>
            <div class="row">
              <span class="pill">Plot B</span><span class="tiny">K(t₀,r), t₀ = current t</span>
            </div>
            <canvas id="cB" width="980" height="340"></canvas>
          </div>
        </div>
      </section>
    </div>

    <footer>
      <div class="credit">
        <b>Built by Darkside</b> • <span>Quantum Dynamic Systems</span>
        <span class="tiny">— offline-first equation lab (v0.2)</span>
      </div>
      <div class="tiny">
        Presets stored locally • Export is JSON • No internet required
      </div>
    </footer>

  </div>

<script>
(() => {
  // ---------- state ----------
  const state = {
    sigma2: 1.0, tau: 1.0, lambda: 1.0, t: 1.2, r: 2.0,
    active: null
  };

  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
  const fmt = (x) => {
    if (!isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax === 0) return "0";
    if (ax >= 1000) return x.toExponential(3);
    if (ax < 0.001) return x.toExponential(3);
    return (Math.round(x * 1e6) / 1e6).toString();
  };

  function K(t, r, sigma2, tau, lambda){
    const at = Math.abs(t);
    const e1 = Math.exp(-at / Math.max(1e-12, tau));
    const e2 = Math.exp(-(r*r) / (2 * Math.max(1e-12, lambda*lambda)));
    return sigma2 * e1 * e2;
  }

  // finite-diff sensitivity norm (rough)
  function sensitivity(){
    const base = K(state.t, state.r, state.sigma2, state.tau, state.lambda);
    const eps = 1e-3;
    const d_sigma2 = (K(state.t, state.r, state.sigma2+eps, state.tau, state.lambda) - base)/eps;
    const d_tau    = (K(state.t, state.r, state.sigma2, state.tau+eps, state.lambda) - base)/eps;
    const d_lambda = (K(state.t, state.r, state.sigma2, state.tau, state.lambda+eps) - base)/eps;
    let best = {k:"σ²", v:d_sigma2};
    if (Math.abs(d_tau) > Math.abs(best.v)) best = {k:"τc", v:d_tau};
    if (Math.abs(d_lambda) > Math.abs(best.v)) best = {k:"λc", v:d_lambda};
    return {base, best};
  }

  // ---------- UI wiring ----------
  const pairs = [
    ["sigma2", "s_sigma2", "n_sigma2", "v_sigma2", 0.01, 5],
    ["tau",    "s_tau",    "n_tau",    "v_tau",    0.05, 10],
    ["lambda", "s_lambda", "n_lambda", "v_lambda", 0.05, 10],
    ["t",      "s_t",      "n_t",      "v_t",      -10, 10],
    ["r",      "s_r",      "n_r",      "v_r",      0, 10],
  ];

  function setVal(key, x){
    const p = pairs.find(z => z[0]===key);
    state[key] = clamp(+x, p[4], p[5]);
    requestRender();
  }

  pairs.forEach(([key, sid, nid, vid]) => {
    const s = $(sid), n = $(nid), v = $(vid);
    const sync = () => {
      s.value = state[key];
      n.value = state[key];
      v.textContent = fmt(state[key]);
    };
    s.addEventListener("input", () => { setVal(key, s.value); sync(); });
    n.addEventListener("input", () => { setVal(key, n.value); sync(); });
    sync();
  });

  // symbol highlight + jump
  const activeSym = $("activeSym");
  function clearActive(){
    document.querySelectorAll(".sym").forEach(el => el.classList.remove("active"));
    state.active = null;
    activeSym.textContent = "—";
  }
  function activate(varKey){
    clearActive();
    state.active = varKey;
    activeSym.textContent = varKey;
    document.querySelectorAll(`.sym[data-var="${varKey}"]`).forEach(el => el.classList.add("active"));
    const target = $(`ctrl_${varKey}`);
    if (target) target.scrollIntoView({behavior:"smooth", block:"center"});
  }
  document.querySelectorAll(".sym").forEach(el => el.addEventListener("click", () => activate(el.dataset.var)));
  $("eqBox").addEventListener("dblclick", clearActive);

  // ---------- plots ----------
  const cA = $("cA"), cB = $("cB");
  const ctxA = cA.getContext("2d");
  const ctxB = cB.getContext("2d");

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
    // subtle grid
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,.06)";
    for (let i=1;i<10;i++){
      const x = (w*i)/10;
      ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke();
    }
    for (let j=1;j<6;j++){
      const y = (h*j)/6;
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke();
    }
  }

  function drawLine(ctx, w, h, xs, ys, stroke){
    let ymin = Infinity, ymax = -Infinity;
    for (const y of ys){ ymin = Math.min(ymin, y); ymax = Math.max(ymax, y); }
    if (!isFinite(ymin) || !isFinite(ymax) || ymax === ymin){ ymin = 0; ymax = 1; }

    const x0 = 34, y0 = 14, pw = w-52, ph = h-36;

    // axes
    ctx.strokeStyle = "rgba(255,255,255,.15)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.lineTo(x0, y0+ph);
    ctx.lineTo(x0+pw, y0+ph);
    ctx.stroke();

    // glow underlay
    ctx.strokeStyle = stroke.replace("0.95", "0.22");
    ctx.lineWidth = 8;
    ctx.lineCap = "round";
    ctx.beginPath();
    for (let i=0;i<xs.length;i++){
      const x = x0 + (xs[i] - xs[0])/(xs[xs.length-1]-xs[0]) * pw;
      const y = y0 + (1 - (ys[i]-ymin)/(ymax-ymin)) * ph;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // main line
    ctx.strokeStyle = stroke;
    ctx.lineWidth = 2.4;
    ctx.beginPath();
    for (let i=0;i<xs.length;i++){
      const x = x0 + (xs[i] - xs[0])/(xs[xs.length-1]-xs[0]) * pw;
      const y = y0 + (1 - (ys[i]-ymin)/(ymax-ymin)) * ph;
      if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // labels
    ctx.fillStyle = "rgba(255,255,255,.58)";
    ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
    ctx.fillText("min " + fmt(ymin), x0+6, y0+ph-6);
    ctx.fillText("max " + fmt(ymax), x0+6, y0+14);
  }

  function renderPlots(){
    const N = 240;

    // Plot A: K vs t, holding r
    clear(ctxA, cA.width, cA.height);
    const xsA = [], ysA = [];
    for (let i=0;i<=N;i++){
      const t = -10 + 20*i/N;
      xsA.push(t);
      ysA.push(K(t, state.r, state.sigma2, state.tau, state.lambda));
    }
    drawLine(ctxA, cA.width, cA.height, xsA, ysA, "rgba(124,247,255,0.95)");

    // Plot B: K vs r, holding t
    clear(ctxB, cB.width, cB.height);
    const xsB = [], ysB = [];
    for (let i=0;i<=N;i++){
      const r = 10*i/N;
      xsB.push(r);
      ysB.push(K(state.t, r, state.sigma2, state.tau, state.lambda));
    }
    drawLine(ctxB, cB.width, cB.height, xsB, ysB, "rgba(167,255,131,0.95)");
  }

  // ---------- numbers ----------
  function renderNumbers(){
    const s = sensitivity();
    $("kNow").textContent = fmt(s.base);
    $("sensNow").textContent = `${s.best.k}: ${fmt(s.best.v)}`;
    $("tSigma").innerHTML = fmt(state.sigma2);
    $("tTau").innerHTML = fmt(state.tau);
    $("tLambda").innerHTML = fmt(state.lambda);
    $("tT").innerHTML = fmt(state.t);
    $("tR").innerHTML = fmt(state.r);
  }

  // ---------- save/load/export ----------
  const KEY = "QDS_EQ_LAB_PRESET_V02";
  function savePreset(){
    const payload = { ...state, savedAt: new Date().toISOString() };
    localStorage.setItem(KEY, JSON.stringify(payload));
  }
  function loadPreset(){
    const raw = localStorage.getItem(KEY);
    if (!raw) return false;
    try{
      const p = JSON.parse(raw);
      ["sigma2","tau","lambda","t","r"].forEach(k => { if (p[k]!=null) state[k] = +p[k]; });
      pairs.forEach(([key, sid, nid, vid]) => {
        $(sid).value = state[key];
        $(nid).value = state[key];
        $(vid).textContent = fmt(state[key]);
      });
      return true;
    }catch(e){ return false; }
  }
  function exportJSON(){
    const payload = {
      title:"Equation Lab — QDS Kernel",
      builtBy:"Darkside",
      company:"Quantum Dynamic Systems",
      exportedAt: new Date().toISOString(),
      equation:"K(t,r)=σ² exp(-|t|/τc) exp(-r²/(2λc²))",
      state:{sigma2:state.sigma2, tau:state.tau, lambda:state.lambda, t:state.t, r:state.r},
      K_now: K(state.t, state.r, state.sigma2, state.tau, state.lambda)
    };
    const txt = JSON.stringify(payload, null, 2);
    const blob = new Blob([txt], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "qds_equation_lab_export.json";
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 250);
  }

  // ---------- copy ----------
  $("btnCopy").addEventListener("click", async () => {
    const s = sensitivity();
    const msg =
`Equation Lab — QDS Kernel
K(t,r)=σ² exp(-|t|/τc) exp(-r²/(2λc²))

σ²=${state.sigma2}
τc=${state.tau}
λc=${state.lambda}
t=${state.t}
r=${state.r}

K_now=${K(state.t,state.r,state.sigma2,state.tau,state.lambda)}
Dominant sensitivity ≈ ${s.best.k}: ${s.best.v}

Built by Darkside — Quantum Dynamic Systems`;
    try{
      await navigator.clipboard.writeText(msg);
      flash("Copied ✅");
    }catch(e){
      flash("Clipboard blocked (Android sometimes).");
    }
  });

  // ---------- buttons ----------
  $("btnReset").addEventListener("click", () => {
    state.sigma2=1; state.tau=1; state.lambda=1; state.t=1.2; state.r=2.0;
    pairs.forEach(([key, sid, nid, vid]) => {
      $(sid).value = state[key];
      $(nid).value = state[key];
      $(vid).textContent = fmt(state[key]);
    });
    clearActive();
    requestRender(true);
  });
  $("btnSave").addEventListener("click", () => { savePreset(); flash("Saved ✅"); });
  $("btnLoad").addEventListener("click", () => {
    const ok = loadPreset();
    flash(ok ? "Loaded ✅" : "No preset yet");
    requestRender(true);
  });
  $("btnExport").addEventListener("click", exportJSON);

  function flash(text){
    const el = $("copyMsg");
    el.textContent = text;
    setTimeout(()=> el.textContent="", 1400);
  }

  // ---------- offline indicator ----------
  function offlineBadge(){
    const dot = $("offlineDot");
    const txt = $("offlineTxt");
    // We are designed offline regardless; show status for confidence.
    const online = navigator.onLine;
    txt.textContent = online ? "Offline-ready (online)" : "Offline OK";
    dot.style.background = online ? "rgba(255,200,87,1)" : "rgba(167,255,131,1)";
  }
  window.addEventListener("online", offlineBadge);
  window.addEventListener("offline", offlineBadge);
  offlineBadge();

  // ---------- enbiggen (A-/A+) ----------
  const UIKEY = "QDS_EQ_LAB_UI_SCALE";
  function getUi(){
    const raw = localStorage.getItem(UIKEY);
    const v = raw ? +raw : 1;
    return Math.max(0.92, Math.min(1.28, v));
  }
  function setUi(v){
    const vv = Math.max(0.92, Math.min(1.28, v));
    document.documentElement.style.setProperty("--ui", vv);
    localStorage.setItem(UIKEY, String(vv));
  }
  setUi(getUi());
  $("btnSmall").addEventListener("click", () => setUi(getUi() - 0.04));
  $("btnBig").addEventListener("click", () => setUi(getUi() + 0.04));

  // ---------- perf pill ----------
  function setPerf(ms){
    $("perfTxt").textContent = ms.toFixed(1) + "ms";
  }

  // ---------- render loop (throttled) ----------
  let pending = false;
  function requestRender(force=false){
    if (pending && !force) return;
    pending = true;
    requestAnimationFrame(() => {
      const t0 = performance.now();
      pending = false;
      renderNumbers();
      renderPlots();
      setPerf(performance.now() - t0);
    });
  }

  // initial render
  requestRender(true);
})();
</script>
</body>
</html>
